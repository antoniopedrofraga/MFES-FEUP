package gui;

import java.awt.Component;
import java.awt.HeadlessException;
import java.io.FileReader;
import java.io.IOException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import javax.swing.JDialog;
import javax.swing.JFileChooser;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import vdmpp.Feature;
import vdmpp.Parent;
import vdmpp.Model;


public class JSONChooser extends JFileChooser {

	private static final long serialVersionUID = -4296681359271965826L;
	
	protected Model displayChooser() {
		int returnVal = this.showOpenDialog(null);
		if(returnVal == JFileChooser.APPROVE_OPTION){
			String path = this.getSelectedFile().getAbsolutePath();
			return getModelFromJson(path);
		} else {
			return null;
		}
	}
	@SuppressWarnings("unchecked")
	private Model getModelFromJson(String path) {
		JSONParser parser = new JSONParser();
		try {
			JSONObject jsonObject = (JSONObject) parser.parse(new FileReader(path));
			Map <String, Feature> featuresMap = new HashMap<>();
			String root = (String) jsonObject.get("root");
			JSONArray features = (JSONArray) jsonObject.get("features");
			
			Iterator<JSONObject> iterator = features.iterator();
			
            while (iterator.hasNext()) {
            	JSONObject featurejson = iterator.next();
            	String name = (String) featurejson.get("name");
            	String type = (String) featurejson.get("type");
            	Feature feature = type == "leaf" ? new Feature(name) : new Parent(type);
            	featuresMap.put(name, feature);
            }
            iterator = features.iterator();
            while (iterator.hasNext()) {
            	JSONObject featurejson = iterator.next();
            	String name = (String) featurejson.get("name");
            	Boolean mandatory = (Boolean) featurejson.get("mandatory");
            	
            	Feature feature = featuresMap.get(name);
            	if (!mandatory) feature.setMandatory(false);
            	if (feature instanceof Parent) {
            		Parent parent = (Parent) feature;
            		String type = (String) featurejson.get("type");
            		JSONArray subFeatures = (JSONArray) jsonObject.get("subFeatures");
            		Iterator<JSONObject> subFeaturesIterator = subFeatures.iterator();
            		
            		if (type == "orParent") parent.setParentType(quotes.orParentQuote.getInstance()); else if (type == "xorParent") parent.setParentType(quotes.xorParentQuote.getInstance());
            		LinkedHashSet<Foo> lhs = new LinkedHashSet<Foo>(hs);
            		while (subFeaturesIterator.hasNext()) {
            			JSONObject subFeature = subFeaturesIterator.next();
            			String subFeatureName = (String) subFeature.get("name");
            		}
            	}
            }
		} catch (IOException | ParseException e) {
			e.printStackTrace();
		}
		return null;
	}
	@Override
	protected JDialog createDialog(Component parent)
			throws HeadlessException {
		JDialog dialog = super.createDialog(parent);
		dialog.setLocationByPlatform(true);
		dialog.setAlwaysOnTop(true);
		return dialog;
	}
}
